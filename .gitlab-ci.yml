variables:
  SSH_SERVER: "gitlab-runner@midnightmechanism.com"

image:
  name: lorisleiva/laravel-docker

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - vendor/

deploy_staging:
  stage: deploy
  before_script:
    - npm install
    - composer install
    - npm run dev
    - echo "$STAGING_ENV" > .env
    - rm -rf storage
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$DEPLOY_KEY")
  script:
    - rsync -ra --exclude=.git ./ $SSH_SERVER:/web/ticksift/staging_temp/
    - ssh $SSH_SERVER "rm -rf /web/ticksift/staging"
    - ssh $SSH_SERVER "mv /web/ticksift/staging_temp /web/ticksift/staging"
    - ssh $SSH_SERVER "ln -s /web/ticksift/storage_staging /web/ticksift/staging/storage"
    - ssh $SSH_SERVER "ln -s /web/ticksift/staging/storage/app/public /web/ticksift/staging/public/storage"
    - ssh $SSH_SERVER "php /web/ticksift/staging/artisan view:clear"
    - ssh $SSH_SERVER "php /web/ticksift/staging/artisan cache:clear"
    - ssh $SSH_SERVER "php /web/ticksift/staging/artisan migrate --force"
  only:
    - develop

deploy_prod:
  stage: deploy
  before_script:
    - npm install
    - composer install
    - npm run prod
    - echo "$PROD_ENV" > .env
    - rm -rf storage
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$DEPLOY_KEY")
  script:
    - rsync -ra --exclude=.git ./ $SSH_SERVER:/web/ticksift/prod_temp/
    - ssh $SSH_SERVER "rm -rf /web/ticksift/prod"
    - ssh $SSH_SERVER "mv /web/ticksift/prod_temp /web/ticksift/prod"
    - ssh $SSH_SERVER "ln -s /web/ticksift/storage_prod /web/ticksift/prod/storage"
    - ssh $SSH_SERVER "ln -s /web/ticksift/prod/storage/app/public /web/ticksift/prod/public/storage"
    - ssh $SSH_SERVER "php /web/ticksift/prod/artisan view:clear"
    - ssh $SSH_SERVER "php /web/ticksift/prod/artisan cache:clear"
    - ssh $SSH_SERVER "php /web/ticksift/prod/artisan migrate --force"
  only:
    - master
